# ğŸ”„ MÃ³dulo 6: Pruebas y Control de Calidad de CÃ³digo
## **Tema 6.3:** IntegraciÃ³n con GitHub (acciones bÃ¡sicas de CI)

---

### ğŸ¯ Objetivos de este tema
- Entender quÃ© es **IntegraciÃ³n Continua (CI)** y por quÃ© usarla.
- Configurar **GitHub Actions** para ejecutar pruebas automÃ¡ticamente.
- Medir cobertura, chequear estilo y tipado (opcional).
- Publicar artefactos (reportes) y usar *caching* para acelerar la CI.
- Aplicar buenas prÃ¡cticas para workflows simples y mantenibles.

---

## ğŸ§© Â¿QuÃ© es CI y quÃ© resuelve?
La **IntegraciÃ³n Continua** ejecuta de forma automÃ¡tica pasos de verificaciÃ³n (tests, estÃ¡tica, build) cada vez que cambiamos el cÃ³digo. Beneficios:
- Detectar **regresiones** tempranas.
- Asegurar **calidad y consistencia** del cÃ³digo.
- Documentar el flujo de validaciÃ³n del proyecto (pipeline como cÃ³digo).
- Facilitar revisiones de **pull requests**.

---

## ğŸ—‚ï¸ Estructura mÃ­nima de CI con GitHub Actions
Los workflows se guardan en:
```
.github/workflows/<nombre>.yml
```

### ğŸš€ Workflow mÃ­nimo (tests con `pytest` y cache de dependencias)
```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ '3.9', '3.10', '3.11', '3.12' ]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests
        run: |
          pytest -q --cov=app --cov-report=xml --junitxml=reports/junit.xml

      - name: Upload coverage.xml & junit.xml
        uses: actions/upload-artifact@v4
        with:
          name: test-reports-${{ matrix.python-version }}
          path: |
            coverage.xml
            reports/junit.xml
```

> **QuÃ© hace**:
> - Corre tests en mÃºltiples versiones de Python (matriz).
> - Usa **cache** para `pip`.
> - Publica **artefactos** (coverage y JUnit) descargables desde la UI.

---

## ğŸ§ª AÃ±adir chequeos de estilo y tipado
PodÃ©s sumar trabajos (jobs) o steps para estÃ¡tica. Separarlos ayuda a ver fallas rÃ¡pidamente.

```yaml
# .github/workflows/ci.yml (fragmento adicional)
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install ruff black mypy
      - name: Ruff (lint)
        run: ruff check .
      - name: Black (format check)
        run: black --check .
      - name: MyPy (type check)
        run: mypy .
```

> **Sugerencia**: empezÃ¡ con **Ruff** + **Black**. AgregÃ¡ **MyPy** de a poco (o solo en `app/` al inicio).

---

## ğŸ§ª Reportes de tests en PRs
Publicar JUnit permite a otras acciones anotar resultados sobre el PR. Otra opciÃ³n:
```yaml
- name: Pytest failure summary
  if: failure()
  run: |
    echo "Some tests failed. See artifacts for details."
```

TambiÃ©n podÃ©s usar *actions* que leen `junit.xml` y comentan el PR con el resumen.

---

## â±ï¸ Acelerar la CI
- **Cache** de `pip` y/o **pip-tools**/Poetry si usÃ¡s lockfiles.
- EvitÃ¡ instalar dependencias pesadas si no son necesarias para tests.
- UsÃ¡ **matrix** solo donde aporte valor (p. ej., liberÃ­as).
- LimpiÃ¡ `pytest -q` y deshabilitÃ¡ *plugins* no usados.

---

## ğŸ” Secrets, variables y entornos
- GuardÃ¡ **secrets** (tokens) en *Settings â†’ Secrets and variables â†’ Actions*.
- UsÃ¡ **variables** para claves no sensibles (nombres, flags).
- **Environments** te permiten _required reviewers_ y *secrets* por entorno (staging/prod).

Ejemplo de uso de secret:
```yaml
env:
  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
```

---

## ğŸ§° Workflow de *build* y publicaciÃ³n (opcional)
### a) Build de paquete Python (sdist + wheel)
```yaml
# .github/workflows/build.yml
name: Build

on:
  push:
    tags: [ 'v*.*.*' ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - run: |
          python -m pip install --upgrade pip build
          python -m build
      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/*
```

### b) PublicaciÃ³n a PyPI (con `PYPI_API_TOKEN`)
```yaml
# .github/workflows/release.yml
name: Release

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - run: |
          python -m pip install --upgrade pip build twine
          python -m build
          python -m twine upload --non-interactive -u __token__ -p ${{ secrets.PYPI_API_TOKEN }} dist/*
```

> **Tip**: versionado por tags (`vX.Y.Z`) y `pyproject.toml` sincronizado.

---

## ğŸ³ Build de imÃ¡genes Docker (opcional)
```yaml
# .github/workflows/docker.yml
name: Docker

on:
  push:
    branches: [ main ]
    paths: [ 'Dockerfile', 'app/**' ]

jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository }}:latest
```

---

## ğŸ§± Reglas Ãºtiles de workflow
- **`concurrency`** para cancelar ejecuciones obsoletas (ahorra minutos):
```yaml
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true
```
- **`paths` / `paths-ignore`** para evitar correr CI cuando no aplica.
- **`workflow_dispatch`** para lanzarlo manualmente.
- **`permissions`** mÃ­nimas necesarias (principio de menor privilegio).
- **`workflow_call`** para reutilizar pipelines entre repos.

---

## ğŸ§ª Ejemplo de repo educativo (estructura sugerida)
```
mi_proyecto/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ operaciones.py
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_operaciones.py
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ pyproject.toml  (opcional: black/ruff/mypy config)
â””â”€â”€ .github/
    â””â”€â”€ workflows/
        â””â”€â”€ ci.yml
```

`requirements.txt` (ejemplo)
```
pytest
pytest-cov
ruff
black
```

---

## âœ… Buenas prÃ¡cticas
- **Fail fast**: separÃ¡ jobs (lint / tests) para ver el fallo antes.
- **RevisÃ¡ tiempos** y quita pasos innecesarios.
- **Cache**: mantenelo alineado con tus lockfiles/requirements.
- **Artefactos**: subÃ­ `coverage.xml` y `junit.xml` para diagnÃ³sticos.
- **ProtegÃ© ramas** (branch protection rules) y exigÃ­ CI verde antes de merge.
- DocumentÃ¡ en el **README** cÃ³mo correr tests localmente y cÃ³mo interpretar la CI.

---

## ğŸ§¾ Resumen
| Tema | Clave |
|---|---|
| GitHub Actions | Workflows en `.github/workflows/*.yml`. |
| Tests | `pytest --cov` + artefactos `coverage.xml` y `junit.xml`. |
| Calidad | `ruff`, `black`, `mypy` (opcional). |
| Rendimiento | Cache de `pip`, matrices razonables. |
| Seguridad | Secrets, permisos mÃ­nimos, entornos. |
| Release | Tags `v*.*.*`, build y (opcional) publicaciÃ³n PyPI/Docker. |

---

## ğŸ”— Recursos
- GitHub Actions: guÃ­a de sintaxis de workflows, `actions/checkout` y `setup-python`.
  - Workflow syntax: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions
  - actions/checkout: https://github.com/actions/checkout
  - actions/setup-python: https://github.com/actions/setup-python
- PyPA: documentaciÃ³n oficial de empaquetado y publicaciÃ³n en PyPI.
  - Packaging Python Projects: https://packaging.python.org/en/latest/
  - Publicar en PyPI (guÃ­a): https://packaging.python.org/en/latest/guides/publishing-package-distribution/
  - Twine (herramienta recomendada): https://pypi.org/project/twine/
- Cobertura y badges:
  - Codecov: https://docs.codecov.com/
  - Coveralls: https://coveralls.io/
- Docker / GitHub Actions:
  - docker/build-push-action (ejemplos y uso): https://github.com/docker/build-push-action

Si querÃ©s mÃ¡s enlaces especÃ­ficos (templates de workflows, ejemplos para proyectos con Poetry, o acciones para comentar PRs con resultados de tests), decÃ­melo y los agrego.

---

> **ConclusiÃ³n**: con un workflow simple de GitHub Actions podÃ©s ejecutar tests y chequeos automÃ¡ticamente en cada push y PR, acelerando revisiones y elevando la calidad del cÃ³digo sin agregar fricciÃ³n al equipo.

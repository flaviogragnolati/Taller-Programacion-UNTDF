# üåê M√≥dulo 7: Desarrollo Web
## **Tema 7.1:** Flask / FastAPI (rutas, controladores, validaci√≥n)

---

### üéØ Objetivos de este tema
- Comprender a grandes rasgos c√≥mo funciona la **web** (cliente/servidor, HTTP, JSON, REST).
- Diferenciar **WSGI** vs **ASGI** y por qu√© importa para apps s√≠ncronas/ASINCR√ìNICAS.
- Construir APIs b√°sicas con **Flask** y **FastAPI**: rutas, controladores y respuestas.
- Aplicar **validaci√≥n** de datos (entrada/salida) y manejo de errores.
- Aprender estructura m√≠nima de proyecto y pruebas r√°pidas de endpoints.

---

## üß© Intro a servidores web y ecosistema
- **Cliente‚ÄìServidor**: un **cliente** (navegador/app) env√≠a **peticiones HTTP** a un **servidor** (tu app).
- **HTTP**: protocolo textual (m√©todos: `GET`, `POST`, `PUT`, `PATCH`, `DELETE`‚Ä¶), **c√≥digos** (`2xx`, `4xx`, `5xx`), **headers**, **cookies**, **body**.
- **REST/JSON**: estilo com√∫n para APIs; recursos con rutas (`/users/1`), operaciones con m√©todos HTTP, **representaciones** en **JSON**.
- **WSGI vs ASGI**:
  - **WSGI** (Flask, Django cl√°sico): modelo **s√≠ncrono** (una petici√≥n por hilo/proceso).
  - **ASGI** (FastAPI, Starlette): **as√≠ncrono** + WebSockets, SSE; mejor para **alta concurrencia**/I/O.
- **Servidor de aplicaci√≥n**: `uvicorn`/`hypercorn` (ASGI) o `gunicorn` (WSGI). En producci√≥n se suele usar **Nginx** como *reverse proxy*.
- **Entorno y despliegue**: virtualenv/Poetry, variables de entorno, contenedores (Docker), logs, m√©tricas.

---

## üß± Comparaci√≥n r√°pida: Flask vs FastAPI
| Aspecto | **Flask** | **FastAPI** |
|---|---|---|
| Filosof√≠a | Micro‚Äëframework minimalista | API‚Äëfirst, tipado est√°tico |
| Protocolo | WSGI (sync) | ASGI (async) |
| Validaci√≥n | Manual o librer√≠as (Marshmallow, Pydantic, etc.) | **Pydantic** integrado (request/response) |
| Documentaci√≥n autom√°tica | Plugins externos | **OpenAPI/Swagger** y **Redoc** autom√°ticos |
| Curva de aprendizaje | Muy suave | Suave (si sab√©s *type hints*) |
| Cu√°ndo usar | Apps simples, prototipos, microservicios peque√±os | APIs de datos, alta concurrencia, validaci√≥n robusta |

---

## üöÄ FastAPI: primera API
### Instalaci√≥n y ejecuci√≥n
```bash
pip install fastapi uvicorn
uvicorn app:app --reload
```
> Crea un archivo `app.py` con el siguiente contenido:

```python
# app.py
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel, Field
from typing import List

app = FastAPI(title="Demo FastAPI")

class ItemIn(BaseModel):
    name: str = Field(min_length=1, max_length=50)
    price: float = Field(gt=0)
    tags: List[str] = []

class ItemOut(ItemIn):
    id: int

DB: list[ItemOut] = []

@app.get("/", tags=["root"])
def root():
    return {"msg": "OK"}

@app.post("/items", response_model=ItemOut, status_code=201, tags=["items"])
def create_item(item: ItemIn):
    new = ItemOut(id=len(DB)+1, **item.model_dump())
    DB.append(new)
    return new

@app.get("/items/{item_id}", response_model=ItemOut, tags=["items"])
def get_item(item_id: int):
    for it in DB:
        if it.id == item_id:
            return it
    raise HTTPException(status_code=404, detail="Item not found")
```

- Documentaci√≥n autom√°tica: abre `http://localhost:8000/docs` (Swagger) o `/redoc`.
- **Validaci√≥n**: `pydantic` valida entrada y salida; errores vienen con JSON detallado.
- **Tipos**: `response_model` impone contrato de salida y oculta campos si quer√©s.
- **Errores**: `HTTPException` maneja c√≥digos y mensajes.

**Path y Query params** (ejemplo r√°pido):
```python
from typing import Optional
@app.get("/filter")
def filter_items(tag: Optional[str] = None, limit: int = 10):
    xs = [x for x in DB if (tag in x.tags) or (tag is None)]
    return xs[:limit]
```

---

## üß≠ Flask: primera API
### Instalaci√≥n y ejecuci√≥n
```bash
pip install flask
python app.py  # si tu archivo se llama app.py
```
> Crea `app.py` con lo siguiente:

```python
# app.py
from flask import Flask, jsonify, request, abort

app = Flask(__name__)
DB = []

@app.get("/")
def root():
    return jsonify(msg="OK")

@app.post("/items")
def create_item():
    data = request.get_json(force=True, silent=True) or {}
    name = data.get("name")
    price = data.get("price")
    if not name or not isinstance(price, (int, float)) or price <= 0:
        abort(400, description="Validaci√≥n inv√°lida")
    item = {"id": len(DB)+1, "name": name, "price": float(price), "tags": data.get("tags", [])}
    DB.append(item)
    return jsonify(item), 201

@app.get("/items/<int:item_id>")
def get_item(item_id):
    for it in DB:
        if it["id"] == item_id:
            return jsonify(it)
    abort(404, description="Item not found")

if __name__ == "__main__":
    app.run(debug=True)
```

> Validaci√≥n: en Flask suele hacerse manualmente o con librer√≠as (p. ej. **Marshmallow**).
> En producci√≥n, preferir `gunicorn` y desactivar `debug=True`.

---

## üß™ Validaci√≥n m√°s robusta en Flask (opcional con Marshmallow)
```bash
pip install marshmallow
```
```python
from marshmallow import Schema, fields, ValidationError

class ItemSchema(Schema):
    name = fields.Str(required=True, validate=lambda s: 0 < len(s) <= 50)
    price = fields.Float(required=True)
    tags = fields.List(fields.Str(), load_default=[])

schema = ItemSchema()

@app.post("/items")
def create_item():
    json = request.get_json() or {}
    try:
        data = schema.load(json)
    except ValidationError as err:
        return {"errors": err.messages}, 400
    item = {"id": len(DB)+1, **data}
    DB.append(item)
    return item, 201
```

---

## üß± Estructura m√≠nima de proyecto
```
mi_api/
‚îú‚îÄ‚îÄ app.py                # o package /app/__init__.py
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ tests/
    ‚îî‚îÄ‚îÄ test_api.py
```

**FastAPI** t√≠pico:
```
mi_api_fast/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py           # instancia FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ models.py         # pydantic BaseModel
‚îÇ   ‚îú‚îÄ‚îÄ routers/          # APIRouter por dominio
‚îÇ   ‚îî‚îÄ‚îÄ deps.py           # dependencias (db, auth, etc.)
‚îî‚îÄ‚îÄ tests/
```

**Flask** t√≠pico:
```
mi_api_flask/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py       # create_app()
‚îÇ   ‚îú‚îÄ‚îÄ routes.py         # Blueprints / rutas
‚îÇ   ‚îî‚îÄ‚îÄ schemas.py        # Marshmallow/Pydantic
‚îî‚îÄ‚îÄ tests/
```

---

## üß¨ Controladores, Blueprints y Routers
- **Flask**: us√° **Blueprints** para modularizar rutas por dominio.
- **FastAPI**: us√° **APIRouter** + `include_router()` para agrupar endpoints, middlewares y dependencias.

**FastAPI ‚Äì Router ejemplo**
```python
# app/routers/items.py
from fastapi import APIRouter
router = APIRouter(prefix="/items", tags=["items"])

@router.get("")
def list_items():
    return [{"id": 1}]

# app/main.py
from fastapi import FastAPI
from .routers import items
app = FastAPI()
app.include_router(items.router)
```

**Flask ‚Äì Blueprint ejemplo**
```python
# app/items.py
from flask import Blueprint, jsonify
bp = Blueprint("items", __name__, url_prefix="/items")

@bp.get("")
def list_items():
    return jsonify([{"id": 1}])

# app/__init__.py
from flask import Flask
from .items import bp as items_bp

def create_app():
    app = Flask(__name__)
    app.register_blueprint(items_bp)
    return app
```

---

## ‚ö†Ô∏è Manejo de errores y respuestas
- **FastAPI**: `HTTPException(status_code, detail)` y validaci√≥n autom√°tica (422).
- **Flask**: `abort(code, description=...)` y **error handlers** globales:

```python
@app.errorhandler(400)
def bad_request(e):
    return {"error": str(e.description)}, 400
```

---

## üîê Nota breve de seguridad
- Validar **entrada** y controlar **tipos** (evitar inyecci√≥n).
- Usar **HTTPS** y manejar **CORS** si hay front-end aparte.
- Autenticaci√≥n: tokens (p. ej. **JWT**), sesiones; **FastAPI** provee dependencias de **OAuth2**.
- Nunca loguear secretos; configurar variables por entorno.

---

## üß™ Pruebas r√°pidas de endpoints
### FastAPI TestClient
```bash
pip install httpx pytest
```
```python
# tests/test_fastapi.py
from fastapi.testclient import TestClient
from app import app

client = TestClient(app)

def test_root():
    r = client.get("/")
    assert r.status_code == 200
    assert r.json()["msg"] == "OK"
```

### Flask test client
```python
# tests/test_flask.py
from app import app

def test_root():
    c = app.test_client()
    r = c.get("/")
    assert r.status_code == 200
```

---

## üßæ Resumen
| Tema | Clave |
|---|---|
| HTTP/REST | M√©todos, rutas, c√≥digos, JSON. |
| WSGI/ASGI | Flask (WSGI), FastAPI (ASGI, async, WebSockets). |
| Rutas/Controladores | Blueprints (Flask) vs Routers (FastAPI). |
| Validaci√≥n | Manual/Marshmallow (Flask) vs Pydantic integrado (FastAPI). |
| Errores | `abort()` (Flask), `HTTPException` (FastAPI). |
| Testing | `TestClient` en ambos; carpeta `tests/`. |

---

## üîó Recursos
- Flask: https://flask.palletsprojects.com/
- FastAPI: https://fastapi.tiangolo.com/
- Pydantic: https://docs.pydantic.dev/
- Starlette (base de FastAPI): https://www.starlette.io/
- HTTP status codes (MDN): https://developer.mozilla.org/en-US/docs/Web/HTTP/Status

---

> **Conclusi√≥n:** con Flask y FastAPI pod√©s crear APIs simples y robustas. Eleg√≠ **Flask** para soluciones minimalistas y **FastAPI** cuando necesites validaci√≥n y concurrencia nativas, documentaci√≥n autom√°tica y desarrollo veloz para APIs modernas.

# üì° M√≥dulo 7: Desarrollo Web
## **Tema 7.3:** APIs REST para tableros y automatizaciones internas

---

### üéØ Objetivos
- Dise√±ar y exponer APIs REST **estables** para tableros (dashboards) y automatizaciones internas.
- Definir contratos (OpenAPI), autenticaci√≥n, paginaci√≥n, filtros y **agregaciones**.
- Implementar endpoints idempotentes para **jobs**/tareas y **webhooks** (event-driven).
- Incorporar **observabilidad** (logging, m√©tricas, trazas) y **buenas pr√°cticas** de seguridad y versi√≥n.

---

## üß© Contexto y casos de uso
- **Tableros internos** (BI/operativos): lecturas intensivas, agregaciones por fecha/√°rea, exportaciones.
- **Automatizaciones**: ejecuci√≥n de procesos (ETL, cierres diarios, notificaciones), integraci√≥n con terceros v√≠a **webhooks** o **polling**.
- **Usuarios**: apps internas, servicios backend, orquestadores (Airflow, Prefect) y herramientas de datos.

### Requisitos t√≠picos
- **Consistencia de contratos**: OpenAPI/JSON.
- **Latencia estable**: endpoints optimizados y cacheables.
- **Idempotencia** en acciones (evitar duplicados).
- **Trazabilidad**: request-id, auditor√≠a y m√©tricas.
- **Seguridad**: autenticaci√≥n por rol, scopes y principio de m√≠nimo privilegio.

---

## üèóÔ∏è Dise√±o de API (convenciones)
### Rutas y recursos
```
/v1/
  metrics/             # agregaciones para dashboards
  reports/             # exportaciones (csv/xlsx/pdf)
  jobs/                # lanzar/revisar tareas
  webhooks/            # endpoints para recibir eventos (entrantes)
  automations/         # configuraciones de reglas/cron internas
```

### Par√°metros de consulta comunes (query)
- **Paginaci√≥n**: `page`, `page_size` (o `limit`/`offset`).
- **Orden**: `order_by` (p. ej. `-created_at`).
- **Filtro por rango temporal**: `date_from`, `date_to`, `tz` (zona horaria expl√≠cita).
- **Selecci√≥n de campos**: `fields=a,b,c` para minimizar payload.
- **Expand**: `expand=items,owner` para incluir relaciones (controlado).

### Formato de respuesta
```json
{
  "data": [...],
  "meta": {
    "page": 1, "page_size": 50, "total": 1234,
    "generated_at": "2025-11-08T18:15:00-03:00",
    "request_id": "a1b2c3"
  }
}
```

### Errores
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "date_from must be before date_to",
    "details": [{"field": "date_from", "msg": "invalid"}],
    "request_id": "a1b2c3"
  }
}
```

### Versionado
- Prefijo en ruta (`/v1/...`). Evitar *breaking changes*; agregar campos **de forma compatible**.
- **Deprecaciones**: header `Deprecation` + changelog.

---

## üîê Autenticaci√≥n y autorizaci√≥n
- **API Keys** (internas/servicio-a-servicio) para lecturas simples.
- **JWT** con **scopes** (`dash:read`, `jobs:write`, `webhook:manage`).
- **RBAC**: roles por grupo/√°rea; **ABAC** si necesit√°s atributos (empresa, sede).
- **Rate limiting**: por `user_id` o `api_key` (p. ej. 60 req/min).

**Headers recomendados**
- `Authorization: Bearer <token>`
- `X-Request-Id` (si no viene, generarlo)
- `Idempotency-Key` (para POST/PUT cr√≠ticos)

---

## üöÄ Endpoints t√≠picos
### 1) M√©tricas para tableros (agregaciones)
```
GET /v1/metrics/production?date_from=2025-01-01&date_to=2025-01-31&group_by=day&tz=America/Argentina/Ushuaia
```
**Respuesta (ejemplo)**
```json
{
  "data": [
    {"date": "2025-01-01", "output_m3": 42.5, "scrap_pct": 3.1},
    {"date": "2025-01-02", "output_m3": 39.8, "scrap_pct": 2.7}
  ],
  "meta": {"group_by": "day", "tz": "America/Argentina/Ushuaia", "page": 1, "page_size": 31, "total": 31}
}
```

**Notas**
- Asegurar **zona horaria** clara en filtros y agregaciones.
- Permitir `group_by={day,week,month,shift}` y **dimensiones** (`plant`, `line`, `product`).
- **Cache-control** para recursos est√°ticos/diarios.

### 2) Exportaciones
```
POST /v1/reports/production-daily
Body: { "date": "2025-01-31", "format": "csv", "plant_id": 2 }
```
**Respuesta 202**: `{"job_id":"J123"}` ‚Üí luego `GET /v1/jobs/J123` devuelve `state=done` + `download_url` (artefacto).

### 3) Lanzar/consultar **jobs**
```
POST /v1/jobs
{ "type": "recompute_kpis", "params": {"date_from":"2025-01-01","date_to":"2025-01-31"} }
```
- **Idempotente** con `Idempotency-Key`.
- Estados: `queued|running|retrying|done|failed|canceled`.
- Campos: `created_at`, `started_at`, `finished_at`, `attempts`, `logs_url`.

### 4) **Webhooks** (entrantes)
```
POST /v1/webhooks/inbound/my_vendor
Headers: X-Signature: sha256=...
Body: { "event":"invoice.paid", "data":{...}, "id":"evt_123", "ts":"..." }
```
- **Verificaci√≥n de firma** (clave compartida).
- **Reintentos** idempotentes por `event.id`.
- Registrar **historial** y **respuesta** (para auditor√≠a).

---

## üß™ Implementaci√≥n de referencia (FastAPI)
```bash
pip install fastapi uvicorn pydantic-settings python-multipart
```
```python
# app/main.py
from fastapi import FastAPI, Depends, Header, HTTPException, status
from pydantic import BaseModel, Field
from typing import Optional, List
from datetime import date
import uuid

app = FastAPI(title="Internal Dash & Automations API", version="1.0.0")

class MetricsQuery(BaseModel):
    date_from: date
    date_to: date
    group_by: str = Field(pattern="^(day|week|month)$")
    tz: str = "America/Argentina/Ushuaia"
    plant_id: Optional[int] = None

class MetricRow(BaseModel):
    date: date
    output_m3: float
    scrap_pct: float

class Meta(BaseModel):
    page: int = 1
    page_size: int = 50
    total: int = 0
    tz: Optional[str] = None
    request_id: Optional[str] = None

class MetricsResponse(BaseModel):
    data: List[MetricRow]
    meta: Meta

def auth(authorization: Optional[str] = Header(None)):
    if not authorization or not authorization.startswith("Bearer "):
        raise HTTPException(status_code=401, detail="Unauthorized")
    # validar JWT/api-key aqu√≠
    return {"user": "internal"}

@app.get("/v1/metrics/production", response_model=MetricsResponse)
def metrics_production(
    date_from: date,
    date_to: date,
    group_by: str = "day",
    tz: str = "America/Argentina/Ushuaia",
    page: int = 1,
    page_size: int = 31,
    user=Depends(auth),
    x_request_id: Optional[str] = Header(None)
):
    # consulta simulada
    rows = [MetricRow(date=date_from, output_m3=42.5, scrap_pct=3.1)]
    meta = Meta(page=page, page_size=page_size, total=1, tz=tz, request_id=x_request_id or str(uuid.uuid4()))
    return MetricsResponse(data=rows, meta=meta)

class JobIn(BaseModel):
    type: str
    params: dict = {}

class JobOut(BaseModel):
    job_id: str
    state: str = "queued"

@app.post("/v1/jobs", response_model=JobOut, status_code=status.HTTP_202_ACCEPTED)
def create_job(payload: JobIn, idempotency_key: Optional[str] = Header(None), user=Depends(auth)):
    # usar idempotency_key para deduplicar
    return JobOut(job_id=str(uuid.uuid4()), state="queued")
```

**Documentaci√≥n**: `/docs` y `/openapi.json`.
**Sugerencia**: separar routers: `routers/metrics.py`, `routers/jobs.py`, etc.

---

## üß≠ Observabilidad y auditor√≠a
- **Logging estructurado** (JSON) con `request_id`, `user_id`, `route`, `latency_ms`, `status`.
- **M√©tricas**: contador por endpoint/estado (`GET /v1/metrics/production 200`), duraci√≥n p95/p99.
- **Trazas**: OpenTelemetry si integr√°s m√∫ltiples servicios.
- **Auditor√≠a**: registro de cambios (qui√©n, cu√°ndo, qu√©) para recursos cr√≠ticos.

---

## ‚öôÔ∏è Performance y cache
- **Indices** y **materialized views** (PostgreSQL) para agregaciones.
- **ETL** nocturnos que precalculan KPIs; API solo **lee**.
- **Cache** por clave de consulta (Redis) con TTL prudente.
- **E-Tag / Last-Modified** en respuestas idempotentes.

---

## üß∞ Idempotencia y reintentos
- En `POST` de creaci√≥n/acci√≥n: exigir `Idempotency-Key` √∫nico por cliente.
- Guardar **hash** (key‚Üíresultado o error) por ventana de tiempo.
- **Backoff exponencial** y jitter en reintentos de clientes/colas.
- Para webhooks: responder 2xx **solo** despu√©s de procesar y registrar.

---

## üîê Seguridad pr√°ctica
- Validar y *sanitize* de entrada; l√≠mites de `page_size`.
- CORS cerrado por defecto; permitir solo or√≠genes internos.
- **Principio de m√≠nimo privilegio** en scopes/roles.
- Rotaci√≥n de claves/tokens; expiraci√≥n corta para JWT.
- No exponer datos sensibles en errores/logs.
- TLS/HTTPS siempre; firmar webhooks (`X-Signature` HMAC-SHA256).

---

## üß™ Testing y CI
- **Tests de contrato** (OpenAPI ‚Üí tests) y **tests de integraci√≥n** con DB/Redis.
- Semillas/fixtures representativas (picos de fin de mes, faltantes).
- CI: `pytest -q --cov` + **lint**; revisar performance de endpoints cr√≠ticos.
- Mock de servicios externos (webhooks salientes) y pruebas de **idempotencia**.

---

## üóÇÔ∏è Ejemplos de consumo
```bash
# m√©trica diaria
curl -H "Authorization: Bearer <TOKEN>"   "https://api.interna/v1/metrics/production?date_from=2025-11-01&date_to=2025-11-07&group_by=day&tz=America/Argentina/Ushuaia"

# lanzar job idempotente
curl -X POST -H "Authorization: Bearer <TOKEN>"   -H "Idempotency-Key: 8b3c1b7e-..."   -H "Content-Type: application/json"   -d '{"type":"recompute_kpis","params":{"date_from":"2025-11-01","date_to":"2025-11-07"}}'   https://api.interna/v1/jobs
```

---

## ‚úÖ Buenas pr√°cticas
- Dise√±ar **para lectura** (dashboards) con agregaciones precalculadas.
- **Contratos claros** y versionados; evitar *breaking changes*.
- **Paginaci√≥n, filtros y l√≠mites** coherentes y documentados.
- **Idempotencia** y **firma de webhooks** por defecto.
- Observabilidad desde el d√≠a 0 (logs, m√©tricas, trazas).
- Seguridad de entorno: variables, secretos, roles y **principio de m√≠nimo privilegio**.

---

## üîó Recursos
- REST API Design Guidelines (Microsoft, Zalando).
- OpenAPI 3.1 Specification.
- FastAPI docs (Response models, Dependencies, Background tasks).
- Postgres: Materialized Views, Timescale/particiones por fecha.
- OpenTelemetry (tracing/metrics/logs).

---

> **Conclusi√≥n**: las APIs para tableros y automatizaciones deben priorizar **contratos s√≥lidos**, **idempotencia**, **seguridad** y **observabilidad**. La combinaci√≥n de agregaciones eficientes + jobs confiables + webhooks firmados produce plataformas internas robustas y auditables.

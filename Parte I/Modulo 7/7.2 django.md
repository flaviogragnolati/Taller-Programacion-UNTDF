# üèõÔ∏è M√≥dulo 7: Desarrollo Web
## **Tema 7.2:** Django ‚Äì visi√≥n general (ORM, Admin, Templates)

---

### üéØ Objetivos de este tema
- Comprender la arquitectura general de **Django** (MTV: Model‚ÄìTemplate‚ÄìView).
- Crear un proyecto y una app, definir **modelos** y ejecutar **migraciones**.
- Usar el **ORM** para consultas comunes.
- Configurar el **Admin** para gesti√≥n interna.
- Renderizar **templates** y manejar URLs y vistas.
- Conocer buenas pr√°cticas, testing b√°sico y opciones de despliegue.

---

## üß© ¬øQu√© es Django y cu√°ndo conviene?
**Django** es un framework web **‚Äúbatteries-included‚Äù** para Python: provee ORM, vistas, templates, formularios, autenticaci√≥n, admin, seguridad y herramientas de despliegue.
Conviene cuando necesit√°s **productividad**, **consistencia** y **convenciones** para construir sitios completos (paneles, autenticaci√≥n, CRUD, formularios, etc.).

Arquitectura **MTV** (similar a MVC):
- **Model**: capa de datos (ORM).
- **Template**: vista de presentaci√≥n (HTML, Jinja-like).
- **View**: l√≥gica de negocio/control (funci√≥n o clase).

---

## ‚öôÔ∏è Instalaci√≥n y primer proyecto
```bash
python -m venv .venv && source .venv/bin/activate  # (Win: .venv\Scripts\activate)
pip install django
django-admin startproject mysite
cd mysite
python manage.py startapp core
python manage.py runserver  # http://127.0.0.1:8000
```

Estructura m√≠nima:
```
mysite/
‚îú‚îÄ‚îÄ manage.py
‚îú‚îÄ‚îÄ mysite/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ asgi.py
‚îÇ   ‚îú‚îÄ‚îÄ settings.py
‚îÇ   ‚îú‚îÄ‚îÄ urls.py
‚îÇ   ‚îî‚îÄ‚îÄ wsgi.py
‚îî‚îÄ‚îÄ core/
    ‚îú‚îÄ‚îÄ admin.py
    ‚îú‚îÄ‚îÄ apps.py
    ‚îú‚îÄ‚îÄ migrations/
    ‚îú‚îÄ‚îÄ models.py
    ‚îú‚îÄ‚îÄ tests.py
    ‚îî‚îÄ‚îÄ views.py
```

Activ√° la app en `mysite/settings.py` ‚Üí `INSTALLED_APPS = [..., "core"]`.

---

## üß¨ Modelos y migraciones
`core/models.py`
```python
from django.db import models

class Product(models.Model):
    name = models.CharField(max_length=120)
    price = models.DecimalField(max_digits=10, decimal_places=2)
    stock = models.PositiveIntegerField(default=0)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ["-created_at"]

    def __str__(self) -> str:
        return f"{self.name} (${self.price})"
```

Aplic√° migraciones:
```bash
python manage.py makemigrations
python manage.py migrate
```

Crea un **superusuario** (para el admin):
```bash
python manage.py createsuperuser
```

---

## üß∞ ORM: consultas esenciales
Entr√° al **shell** con contexto Django:
```bash
python manage.py shell
```
```python
from core.models import Product

# Crear
p = Product.objects.create(name="Serr√≠n bolsa 20kg", price=3500, stock=12)

# Leer
todos = Product.objects.all()            # queryset lazy
primero = Product.objects.first()
filtrados = Product.objects.filter(price__gte=3000, name__icontains="serr√≠n")

# Actualizar
p.stock += 3
p.save(update_fields=["stock"])

# Borrar
Product.objects.filter(stock=0).delete()

# Agregaciones
from django.db.models import Count, Avg, Sum
summary = Product.objects.aggregate(total=Count("id"), avg_price=Avg("price"), stock=Sum("stock"))
```

Relaciones (ejemplo r√°pido):
```python
class Category(models.Model):
    name = models.CharField(max_length=120, unique=True)

class Product(models.Model):
    category = models.ForeignKey(Category, on_delete=models.PROTECT, related_name="products")
    # ... otros campos
```
Consultas:
```python
Category.objects.prefetch_related("products").get(pk=1)
Product.objects.select_related("category").all()
```

---

## üóÇÔ∏è Admin de Django
`core/admin.py`
```python
from django.contrib import admin
from .models import Product, Category

@admin.register(Product)
class ProductAdmin(admin.ModelAdmin):
    list_display = ("id", "name", "price", "stock", "created_at")
    list_filter = ("created_at", "category")
    search_fields = ("name", )
    autocomplete_fields = ("category",)
    ordering = ("-created_at",)

admin.site.register(Category)
```
Acced√© a `http://127.0.0.1:8000/admin/` con tu superusuario.

**Tips**:
- `list_display`, `list_filter`, `search_fields` mejoran la usabilidad.
- `readonly_fields`, `fieldsets` para formularios complejos.
- `actions` para operaciones masivas.

---

## üß≠ Vistas, URLs y Templates
### 1) Rutas (URLs)
`mysite/urls.py`
```python
from django.contrib import admin
from django.urls import path
from core import views

urlpatterns = [
    path("admin/", admin.site.urls),
    path("", views.home, name="home"),
    path("products/", views.ProductListView.as_view(), name="product_list"),
]
```

### 2) Vistas (funci√≥n y clase)
`core/views.py`
```python
from django.shortcuts import render, get_object_or_404
from django.views.generic import ListView
from .models import Product

def home(request):
    ctx = {"title": "Bienvenido", "count": Product.objects.count()}
    return render(request, "core/home.html", ctx)

class ProductListView(ListView):
    model = Product
    template_name = "core/product_list.html"
    paginate_by = 10
```

### 3) Templates
```
mysite/
‚îî‚îÄ‚îÄ templates/
    ‚îî‚îÄ‚îÄ core/
        ‚îú‚îÄ‚îÄ base.html
        ‚îú‚îÄ‚îÄ home.html
        ‚îî‚îÄ‚îÄ product_list.html
```
`mysite/settings.py` (configuraci√≥n de templates):
```python
TEMPLATES = [
  {
    "BACKEND": "django.template.backends.django.DjangoTemplates",
    "DIRS": [BASE_DIR / "templates"],
    "APP_DIRS": True,
    "OPTIONS": {"context_processors": [
        "django.template.context_processors.debug",
        "django.template.context_processors.request",
        "django.contrib.auth.context_processors.auth",
        "django.contrib.messages.context_processors.messages",
    ]},
  }
]
```

`templates/core/base.html`
```html
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <title>{% block title %}Mi sitio{% endblock %}</title>
  </head>
  <body>
    <header><h1>Mi sitio</h1></header>
    <main>{% block content %}{% endblock %}</main>
  </body>
</html>
```

`templates/core/home.html`
```html
{% extends "core/base.html" %}
{% block title %}Inicio{% endblock %}
{% block content %}
  <p>Total de productos: {{ count }}</p>
  <a href="{% url 'product_list' %}">Ver productos</a>
{% endblock %}
```

`templates/core/product_list.html`
```html
{% extends "core/base.html" %}
{% block title %}Productos{% endblock %}
{% block content %}
  <ul>
    {% for p in object_list %}
      <li>{{ p.name }} ‚Äì ${{ p.price }} (stock: {{ p.stock }})</li>
    {% empty %}
      <li>No hay productos</li>
    {% endfor %}
  </ul>

  {% if is_paginated %}
    <nav>
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}">Anterior</a>
      {% endif %}
      <span>P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}">Siguiente</a>
      {% endif %}
    </nav>
  {% endif %}
{% endblock %}
```

---

## üßæ Formularios (Forms) y validaci√≥n (breve)
```python
# core/forms.py
from django import forms
from .models import Product

class ProductForm(forms.ModelForm):
    class Meta:
        model = Product
        fields = ("name", "price", "stock", "category")
```
`core/views.py` (ejemplo de CreateView):
```python
from django.views.generic import CreateView
from django.urls import reverse_lazy

class ProductCreateView(CreateView):
    model = Product
    form_class = ProductForm
    success_url = reverse_lazy("product_list")
```
- Validaci√≥n declarativa en `forms`, y **clean_*** para reglas personalizadas.
- `ModelForm` mapea modelos‚Üîformularios autom√°ticamente.

---

## üß™ Testing b√°sico
```bash
python manage.py test
```
`core/tests.py`
```python
from django.test import TestCase
from .models import Product

class ProductModelTests(TestCase):
    def test_create(self):
        p = Product.objects.create(name="Tabl√≥n lenga", price=12000, stock=5)
        self.assertTrue(Product.objects.filter(pk=p.pk).exists())
```

---

## üîê Seguridad y configuraci√≥n
- SECRET_KEY, DEBUG, ALLOWED_HOSTS por **variables de entorno**.
- Protecciones integradas: **CSRF**, **XSS**, **clickjacking**.
- Users/Auth/Permissions integradas (√∫tiles para paneles y apps internas).
- Archivos est√°ticos y media: `STATIC_URL`, `MEDIA_URL` + `collectstatic` (en prod).

---

## üß± M√∫ltiples ambientes y despliegue
- Settings por ambiente: `settings/` con `base.py`, `dev.py`, `prod.py` o `django-environ`.
- **Despliegue**: Gunicorn/Uvicorn + Nginx, base de datos (PostgreSQL recomendado), supervisi√≥n (systemd), logs.
- **Docker**: imagen con `python:3.x-slim`, *multi-stage build* y `collectstatic` en release.

---

## üåê APIs con Django (nota r√°pida)
- Para APIs REST, usar **Django REST Framework (DRF)**: serializers, viewsets, routers, permisos, throttling, browsable API.
- Alternativa ASGI moderna: **FastAPI** (ver Tema 7.1).

---

## ‚úÖ Buenas pr√°cticas
- Modelos peque√±os y expl√≠citos; usar **choices**, **constraints** y **validators**.
- Consultas eficientes: **select_related/prefetch_related** y **paginaci√≥n**.
- Mantener apps **cohesivas** (dominio claro).
- `admin.py` con `list_display/search_fields` para productividad.
- Templates con **herencia** y **bloques**; evitar l√≥gica compleja en templates.
- Tests para modelos y vistas cr√≠ticas; **fixtures** para datos.
- Separar settings por ambiente y gestionar secrets con el sistema del host o `dotenv`/`environ`.

---

## üßæ Resumen
| Tema | Clave |
|---|---|
| Proyecto/App | `startproject`, `startapp`, `INSTALLED_APPS`. |
| Modelos/ORM | Definir modelos, migraciones, consultas y relaciones. |
| Admin | Registro y personalizaci√≥n (`ModelAdmin`). |
| Vistas/URLs | Funciones o clases + `path()` en `urls.py`. |
| Templates | Herencia (`base.html`), bloques, tags y filtros. |
| Forms | `ModelForm`, validaci√≥n y CBVs (`CreateView`). |
| Testing | `manage.py test`, `TestCase`. |
| Despliegue | Gunicorn/Uvicorn + Nginx, PostgreSQL, staticfiles. |

---

## üîó Recursos
- Documentaci√≥n oficial: https://docs.djangoproject.com/
- Tutorial oficial de Django: https://docs.djangoproject.com/en/stable/intro/
- Django Admin docs: https://docs.djangoproject.com/en/stable/ref/contrib/admin/
- Django ORM cookbook (no oficial): https://books.agiliq.com/projects/django-orm-cookbook/
- Django REST Framework: https://www.django-rest-framework.org/

---

> **Conclusi√≥n**: Django acelera la creaci√≥n de sitios completos con una arquitectura s√≥lida y componentes integrados. Su **ORM**, **Admin** y **Templates** permiten ir de la idea al prototipo funcional y luego a producci√≥n con un mismo stack coherente.
